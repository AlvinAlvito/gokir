generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql" // ganti ke "postgresql" atau "mysql" nanti
  url      = env("DATABASE_URL")
}

enum Role {
  CUSTOMER
  DRIVER
  STORE
  ADMIN
  SUPERADMIN
}

enum DriverStatus {
  PENDING
  APPROVED
  REJECTED
}

model User {
  id              String  @id @default(cuid())
  username        String? @unique
  email           String? @unique
  phone           String?
  passwordHash    String?
  role            Role
  isEmailVerified Boolean @default(false)

  // login/audit
  lastLoginAt DateTime?
  lastLoginIp String?
  lastLoginUA String?

  // relations
  oauthAccounts   OAuthAccount[]
  customerProfile CustomerProfile?
  driverProfile   DriverProfile?
  storeProfile    StoreProfile?
  auditLogs       AuditLog[]

  reviewedDrivers DriverProfile[] @relation("ReviewedBy")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model OAuthAccount {
  id             String @id @default(cuid())
  provider       String
  providerUserId String
  userId         String
  user           User   @relation(fields: [userId], references: [id])

  createdAt DateTime @default(now())

  @@unique([provider, providerUserId])
}

model CustomerProfile {
  id     String @id @default(cuid())
  userId String @unique
  user   User   @relation(fields: [userId], references: [id])

  // profil pelengkap
  name     String?
  photoUrl String?
  nim      String?
  whatsapp String?
  address  String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model StoreProfile {
  id     String @id @default(cuid())
  userId String @unique
  user   User   @relation(fields: [userId], references: [id])

  storeName   String?
  description String?
  categories  String? // CSV sementara (nanti bisa jadi tabel relasi)
  photoUrl    String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model DriverProfile {
  id     String @id @default(cuid())
  userId String @unique
  user   User   @relation(fields: [userId], references: [id])

  name           String
  nim            String
  birthPlace     String
  birthDate      DateTime
  idCardUrl      String // KTP
  studentCardUrl String // KTM
  facePhotoUrl   String
  status         DriverStatus @default(PENDING)

  reviewedById String?
  reviewedBy   User?   @relation("ReviewedBy", fields: [reviewedById], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model VerificationToken {
  id         String   @id @default(cuid())
  identifier String // email
  token      String   @unique
  expiresAt  DateTime
  createdAt  DateTime @default(now())

  @@index([identifier])
}

model AuditLog {
  id        String   @id @default(cuid())
  userId    String?
  user      User?    @relation(fields: [userId], references: [id])
  action    String
  ip        String?
  userAgent String?
  createdAt DateTime @default(now())
}
