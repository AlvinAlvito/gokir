generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql" // ganti ke "postgresql" atau "mysql" nanti
  url      = env("DATABASE_URL")
}

enum Role {
  CUSTOMER
  DRIVER
  STORE
  ADMIN
  SUPERADMIN
}

model User {
  id              String  @id @default(cuid())
  username        String? @unique
  email           String? @unique
  phone           String?
  passwordHash    String?
  role            Role
  isEmailVerified Boolean @default(false)

  // login/audit
  lastLoginAt DateTime?
  lastLoginIp String?
  lastLoginUA String?

  // relations
  oauthAccounts      OAuthAccount[]
  customerProfile    CustomerProfile?
  driverProfile      DriverProfile?
  driverAvailability DriverAvailability?
  ticketBalance      TicketBalance?
  ticketOrders       TicketOrder[]
  ticketTransactions TicketTransaction[]
  storeProfile       StoreProfile?
  auditLogs          AuditLog[]

  reviewedDrivers DriverProfile[] @relation("ReviewedBy")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model OAuthAccount {
  id             String @id @default(cuid())
  provider       String
  providerUserId String
  userId         String
  user           User   @relation(fields: [userId], references: [id])

  createdAt DateTime @default(now())

  @@unique([provider, providerUserId])
}

model CustomerProfile {
  id     String @id @default(cuid())
  userId String @unique
  user   User   @relation(fields: [userId], references: [id])

  // profil pelengkap
  name     String?
  photoUrl String?
  nim      String?
  whatsapp String?
  address  String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model StoreProfile {
  id     String @id @default(cuid())
  userId String @unique
  user   User   @relation(fields: [userId], references: [id])

  storeName   String?
  description String?
  categories  String? // CSV sementara (nanti bisa jadi tabel relasi)
  photoUrl    String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

enum DriverStatus {
  PENDING
  APPROVED
  REJECTED
}

enum DriverAvailabilityStatus {
  ACTIVE
  INACTIVE
}

enum DriverRegion {
  KAMPUS_SUTOMO
  KAMPUS_TUNTUNGAN
  KAMPUS_PANCING
  WILAYAH_LAINNYA
}

enum TicketTransactionType {
  GRANT_INITIAL
  PURCHASE
  CONSUME
  ADJUST
}

enum TicketOrderStatus {
  PENDING
  PAID
  CANCELLED
}

enum PaymentMethod {
  QRIS
}

model DriverProfile {
  id     String @id @default(cuid())
  userId String @unique
  user   User   @relation(fields: [userId], references: [id])

  // profil
  name           String?
  nim            String?
  birthPlace     String?
  birthDate      DateTime?
  idCardUrl      String?
  studentCardUrl String?
  facePhotoUrl   String?
  whatsapp       String?
  address        String?

  status DriverStatus @default(PENDING)

  // reviewer (baru)
  reviewedById String?
  reviewedBy   User?   @relation("ReviewedBy", fields: [reviewedById], references: [id])

  createdAt DateTime @default(now())
}

model DriverAvailability {
  id          String                   @id @default(cuid())
  userId      String                   @unique
  user        User                     @relation(fields: [userId], references: [id])
  status      DriverAvailabilityStatus @default(INACTIVE)
  region      DriverRegion             @default(WILAYAH_LAINNYA)
  locationUrl String?
  latitude    Float?
  longitude   Float?
  note        String?
  updatedAt   DateTime                 @updatedAt
  createdAt   DateTime                 @default(now())
}

model TicketBalance {
  id        String   @id @default(cuid())
  userId    String   @unique
  user      User     @relation(fields: [userId], references: [id])
  balance   Int      @default(0)
  updatedAt DateTime @updatedAt
  createdAt DateTime @default(now())
}

model TicketTransaction {
  id          String                @id @default(cuid())
  userId      String
  user        User                  @relation(fields: [userId], references: [id])
  type        TicketTransactionType
  amount      Int
  description String?
  referenceId String?
  createdAt   DateTime              @default(now())

  @@index([userId, createdAt])
}

model TicketOrder {
  id             String            @id @default(cuid())
  userId         String
  user           User              @relation(fields: [userId], references: [id])
  quantity       Int
  pricePerTicket Int
  totalAmount    Int
  status         TicketOrderStatus @default(PENDING)
  paymentMethod  PaymentMethod     @default(QRIS)
  paymentPayload String?
  midtransOrderId String? @unique
  paymentUrl     String?
  paymentStatusRaw String?
  paidAt         DateTime?
  createdAt      DateTime          @default(now())
  updatedAt      DateTime          @updatedAt

  @@index([userId, status])
}

model VerificationToken {
  id         String   @id @default(cuid())
  identifier String // email
  token      String   @unique
  expiresAt  DateTime
  createdAt  DateTime @default(now())

  @@index([identifier])
}

model AuditLog {
  id        String   @id @default(cuid())
  userId    String?
  user      User?    @relation(fields: [userId], references: [id])
  action    String
  ip        String?
  userAgent String?
  createdAt DateTime @default(now())
}

// Pengumuman / slider info (mading)
model Announcement {
  id          String   @id @default(cuid())
  slug        String   @unique // identitas unik untuk upsert/seed
  title       String
  description String
  imageUrl    String
  link        String?
  forRole     Role? // null = untuk semua role
  sortOrder   Int      @default(0)
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([forRole, isActive])
}
