generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql" // ganti ke "postgresql" atau "mysql" nanti
  url      = env("DATABASE_URL")
}

enum Role {
  CUSTOMER
  DRIVER
  STORE
  ADMIN
  SUPERADMIN
}

model User {
  id              String  @id @default(cuid())
  username        String? @unique
  email           String? @unique
  phone           String?
  passwordHash    String?
  role            Role
  isEmailVerified Boolean @default(false)

  // login/audit
  lastLoginAt DateTime?
  lastLoginIp String?
  lastLoginUA String?

  // relations
  oauthAccounts      OAuthAccount[]
  customerProfile    CustomerProfile?
  driverProfile      DriverProfile?
  driverAvailability DriverAvailability?
  storeAvailability  StoreAvailability?
  ticketBalance      TicketBalance?
  ticketOrders       TicketOrder[]
  ticketTransactions TicketTransaction[]
  storeProfile       StoreProfile?
  menuCategories     MenuCategory[]
  menuItems          MenuItem[]
  customerOrders     CustomerOrder[] @relation("CustomerOrders")
  storeOrders        CustomerOrder[] @relation("StoreOrders")
  driverOrders       CustomerOrder[] @relation("DriverOrders")
  auditLogs          AuditLog[]

  reviewedDrivers DriverProfile[] @relation("ReviewedBy")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model OAuthAccount {
  id             String @id @default(cuid())
  provider       String
  providerUserId String
  userId         String
  user           User   @relation(fields: [userId], references: [id])

  createdAt DateTime @default(now())

  @@unique([provider, providerUserId])
}

model CustomerProfile {
  id     String @id @default(cuid())
  userId String @unique
  user   User   @relation(fields: [userId], references: [id])

  // profil pelengkap
  name     String?
  photoUrl String?
  nim      String?
  whatsapp String?
  address  String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model StoreProfile {
  id     String @id @default(cuid())
  userId String @unique
  user   User   @relation(fields: [userId], references: [id])

  storeName   String?
  ownerName   String?
  address     String?
  mapsUrl     String?
  description String?
  categories  String? // CSV sementara (nanti bisa jadi tabel relasi)
  photoUrl    String?
  status      StoreStatus @default(PENDING)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

enum DriverStatus {
  PENDING
  APPROVED
  REJECTED
}

enum DriverAvailabilityStatus {
  ACTIVE
  INACTIVE
}

enum StoreStatus {
  PENDING
  APPROVED
  REJECTED
}

enum DriverRegion {
  KAMPUS_SUTOMO
  KAMPUS_TUNTUNGAN
  KAMPUS_PANCING
  WILAYAH_LAINNYA
}

enum TicketTransactionType {
  GRANT_INITIAL
  PURCHASE
  CONSUME
  ADJUST
}

enum TicketOrderStatus {
  PENDING
  PAID
  CANCELLED
}

enum PaymentMethod {
  QRIS
  CASH
}

model DriverProfile {
  id     String @id @default(cuid())
  userId String @unique
  user   User   @relation(fields: [userId], references: [id])

  // profil
  name           String?
  nim            String?
  birthPlace     String?
  birthDate      DateTime?
  idCardUrl      String?
  studentCardUrl String?
  facePhotoUrl   String?
  whatsapp       String?
  address        String?

  status DriverStatus @default(PENDING)

  // reviewer (baru)
  reviewedById String?
  reviewedBy   User?   @relation("ReviewedBy", fields: [reviewedById], references: [id])

  createdAt DateTime @default(now())
}

model DriverAvailability {
  id          String                   @id @default(cuid())
  userId      String                   @unique
  user        User                     @relation(fields: [userId], references: [id])
  status      DriverAvailabilityStatus @default(INACTIVE)
  region      DriverRegion             @default(WILAYAH_LAINNYA)
  locationUrl String?
  latitude    Float?
  longitude   Float?
  note        String?
  updatedAt   DateTime                 @updatedAt
  createdAt   DateTime                 @default(now())
}

model StoreAvailability {
  id          String                   @id @default(cuid())
  userId      String                   @unique
  user        User                     @relation(fields: [userId], references: [id])
  status      DriverAvailabilityStatus @default(INACTIVE) // gunakan enum yang sama: ACTIVE/INACTIVE
  region      DriverRegion             @default(WILAYAH_LAINNYA)
  locationUrl String?
  latitude    Float?
  longitude   Float?
  note        String?
  openDays    String?                  // CSV hari buka
  openTime    String?                  // jam buka (HH:mm)
  closeTime   String?                  // jam tutup (HH:mm)
  updatedAt   DateTime                 @updatedAt
  createdAt   DateTime                 @default(now())
}

enum MenuOptionGroupType {
  SINGLE
  MULTIPLE
}

model MenuCategory {
  id          String   @id @default(cuid())
  storeId     String
  store       User     @relation(fields: [storeId], references: [id])
  name        String
  description String?
  sortOrder   Int      @default(0)
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  menuItems   MenuItem[]

  @@index([storeId, sortOrder])
}

model MenuItem {
  id          String   @id @default(cuid())
  storeId     String
  store       User     @relation(fields: [storeId], references: [id])
  categoryId  String?
  category    MenuCategory? @relation(fields: [categoryId], references: [id])
  name        String
  description String?
  price       Int
  promoPrice  Int?
  photoUrl    String?
  // akan simpan sebagai path upload; kolom ini tetap String, tapi API akan upload file dan isi path-nya
  isAvailable Boolean  @default(true)
  isActive    Boolean  @default(true)
  sortOrder   Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  optionGroups MenuOptionGroup[]
  orders       CustomerOrder[]

  @@index([storeId, categoryId, sortOrder])
}

model MenuOptionGroup {
  id         String              @id @default(cuid())
  menuItemId String
  menuItem   MenuItem            @relation(fields: [menuItemId], references: [id])
  name       String
  type       MenuOptionGroupType
  isRequired Boolean             @default(false)
  minSelect  Int?                @default(0)
  maxSelect  Int?                @default(1)
  sortOrder  Int                 @default(0)
  createdAt  DateTime            @default(now())
  updatedAt  DateTime            @updatedAt

  options MenuOption[]

  @@index([menuItemId, sortOrder])
}

model MenuOption {
  id          String   @id @default(cuid())
  groupId     String
  group       MenuOptionGroup @relation(fields: [groupId], references: [id])
  name        String
  priceDelta  Int      @default(0)
  isAvailable Boolean  @default(true)
  sortOrder   Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([groupId, sortOrder])
}

enum CustomerOrderStatus {
  WAITING_STORE_CONFIRM
  REJECTED
  CONFIRMED_COOKING
  SEARCHING_DRIVER
  DRIVER_ASSIGNED
  ON_DELIVERY
  COMPLETED
  CANCELLED
}

enum CustomerOrderType {
  FOOD_EXISTING_STORE
  FOOD_CUSTOM_STORE
  RIDE
}

model CustomerOrder {
  id             String   @id @default(cuid())
  customerId     String
  storeId        String?
  menuItemId     String?
  driverId       String?
  quantity       Int?
  note           String?  @db.Text
  paymentMethod  PaymentMethod @default(CASH)
  status         CustomerOrderStatus @default(WAITING_STORE_CONFIRM)
  orderType      CustomerOrderType @default(FOOD_EXISTING_STORE)
  customStoreName    String?
  customStoreAddress String?
  pickupAddress      String?
  dropoffAddress     String?
  createdAt      DateTime @default(now())

  customer       User      @relation("CustomerOrders", fields: [customerId], references: [id])
  store          User?     @relation("StoreOrders", fields: [storeId], references: [id])
  driver         User?     @relation("DriverOrders", fields: [driverId], references: [id])
  menuItem       MenuItem? @relation(fields: [menuItemId], references: [id])

  @@index([customerId, createdAt])
  @@index([storeId])
  @@index([driverId])
}

model TicketBalance {
  id        String   @id @default(cuid())
  userId    String   @unique
  user      User     @relation(fields: [userId], references: [id])
  balance   Int      @default(0)
  updatedAt DateTime @updatedAt
  createdAt DateTime @default(now())
}

model TicketTransaction {
  id          String                @id @default(cuid())
  userId      String
  user        User                  @relation(fields: [userId], references: [id])
  type        TicketTransactionType
  amount      Int
  description String?
  referenceId String?
  createdAt   DateTime              @default(now())

  @@index([userId, createdAt])
}

model TicketOrder {
  id             String            @id @default(cuid())
  userId         String
  user           User              @relation(fields: [userId], references: [id])
  quantity       Int
  pricePerTicket Int
  totalAmount    Int
  status         TicketOrderStatus @default(PENDING)
  paymentMethod  PaymentMethod     @default(QRIS)
  paymentPayload String?
  midtransOrderId String? @unique
  paymentUrl     String?
  paymentStatusRaw String?
  paidAt         DateTime?
  createdAt      DateTime          @default(now())
  updatedAt      DateTime          @updatedAt

  @@index([userId, status])
}

model VerificationToken {
  id         String   @id @default(cuid())
  identifier String // email
  token      String   @unique
  expiresAt  DateTime
  createdAt  DateTime @default(now())

  @@index([identifier])
}

model AuditLog {
  id        String   @id @default(cuid())
  userId    String?
  user      User?    @relation(fields: [userId], references: [id])
  action    String
  ip        String?
  userAgent String?
  createdAt DateTime @default(now())
}

// Pengumuman / slider info (mading)
model Announcement {
  id          String   @id @default(cuid())
  slug        String   @unique // identitas unik untuk upsert/seed
  title       String
  description String
  imageUrl    String
  link        String?
  forRole     Role? // null = untuk semua role
  sortOrder   Int      @default(0)
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([forRole, isActive])
}
